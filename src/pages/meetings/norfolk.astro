---
// ============================================================================
// LOCATION CONFIGURATION - Change these values to create a page for a new city
// ============================================================================
const LOCATION = {
  // City/location name (used in titles, headings, etc.)
  city: 'Norfolk',
  // State abbreviation
  stateAbbr: 'VA',
  // Full state name
  stateFull: 'Virginia',
  // Region (for geo meta tags, e.g., 'US-MA', 'US-NY', 'US-CA')
  geoRegion: 'US-VA',
  // URL slug (lowercase, no spaces)
  slug: 'norfolk',
  // Latitude for map center and API query
  lat: 36.8508,
  // Longitude for map center and API query
  lng: -76.2859,
  // Area description (e.g., 'Greater Boston area', 'New York City area')
  areaDescription: 'Norfolk / Hampton Roads area',
  // Neighborhoods/areas for SEO content (comma-separated list)
  neighborhoods: 'Downtown, Freemason District, Ghent, Colley Bayview, Ocean View, and surrounding neighborhoods',
};

// ============================================================================
// DERIVED CONSTANTS (auto-generated from LOCATION config)
// ============================================================================
const title = `AA Meetings in ${LOCATION.city}, ${LOCATION.stateAbbr} - Find Alcoholics Anonymous Near You | MyMeetings`;
const description = `Find AA meetings in ${LOCATION.city}, ${LOCATION.stateFull}. Browse 100+ Alcoholics Anonymous meetings with times, locations, and directions. Open meetings, closed meetings, speaker meetings, and more. Updated daily.`;
const canonical = `https://gskis.com/meetings/${LOCATION.slug}`;
const appStoreUrl = 'https://apps.apple.com/app/id6748364894';
const locationLat = LOCATION.lat;
const locationLng = LOCATION.lng;

// SEO-related constants
const siteName = 'MyMeetings';
const ogImage = `https://gskis.com/myMeetingsAppLogo.webp`;
const keywords = `AA meetings ${LOCATION.city}, Alcoholics Anonymous ${LOCATION.city}, AA near me, ${LOCATION.city} AA meetings, recovery meetings ${LOCATION.city}, 12 step meetings ${LOCATION.city}, AA meeting times ${LOCATION.city}, open AA meetings ${LOCATION.city}, closed AA meetings ${LOCATION.city}`;

let meetings = [];
try {
  const res = await fetch(`https://api.meetingguide.org/app/v2/request?latitude=${locationLat}&longitude=${locationLng}`);
  if (res.ok) {
    const json = await res.json();
    meetings = json?.meetings ?? json ?? [];
  } else {
    console.error('Meetings fetch failed', res.status);
  }
} catch (e) {
  console.error(e);
}

function formatTime(t: any) {
  if (!t) return '';
  const [h, m] = String(t).split(':');
  const hour = parseInt(h || '0', 10);
  const ampm = hour >= 12 ? 'PM' : 'AM';
  const hour12 = hour % 12 === 0 ? 12 : hour % 12;
  return `${hour12}:${m || '00'} ${ampm}`;
}

function dayOfWeek(num: any) {
  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  return days[Number(num) || 0];
}

// Map meeting type to CSS class (matching [id].astro)
const typeToClass: Record<string, string> = {
  'Beginner': 'type-badge-beginner',
  'Big Book': 'type-badge-bigbook',
  'Closed': 'type-badge-closed',
  'Discussion': 'type-badge-discussion',
  'English': 'type-badge-english',
  'Grapevine': 'type-badge-grapevine',
  'Literature': 'type-badge-literature',
  'Men': 'type-badge-men',
  'Open': 'type-badge-open',
  'Step': 'type-badge-step',
  'Speaker': 'type-badge-speaker',
  'Step/Tradition': 'type-badge-steptradition',
  'Tradition': 'type-badge-tradition',
  'Women': 'type-badge-women',
  'Wheelchair Access': 'type-badge-wheelchair',
  'Young People': 'type-badge-youngpeople',
};

const normalizedMeetings = (meetings || []).map((m: any) => ({
  ...m,
  latitude: m.latitude ? Number(m.latitude) : m.lat ? Number(m.lat) : null,
  longitude: m.longitude ? Number(m.longitude) : m.lng ? Number(m.lng) : null,
  display_time: m.time ? formatTime(m.time) : '',
  display_day: m.day != null ? dayOfWeek(m.day) : '',
  display_address: m.formatted_address || m.location || m.address || '',
  types_array: m.types ? String(m.types).split(',').map(t => t.trim()).filter(Boolean) : []
}));
const initialMeetingsJSON = JSON.stringify(normalizedMeetings).replace(/</g, '\u003c');
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/x-icon" href="/myMeetings.ico" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonical} />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <!-- iOS Smart App Banner -->
    <meta name="apple-itunes-app" content={`app-id=6748364894, app-argument=mymeetings://meetings/${LOCATION.slug}`} />
    
    <!-- Additional SEO Meta Tags -->
    <meta name="robots" content="index, follow" />
    <meta name="googlebot" content="index, follow" />
    <meta name="keywords" content={keywords} />
    <meta name="author" content="MyMeetings" />
    <meta name="geo.region" content={LOCATION.geoRegion} />
    <meta name="geo.placename" content={LOCATION.city} />
    <meta name="geo.position" content={`${LOCATION.lat};${LOCATION.lng}`} />
    <meta name="ICBM" content={`${LOCATION.lat}, ${LOCATION.lng}`} />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonical} />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:locale" content="en_US" />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content={`AA Meetings in ${LOCATION.city} - Find Alcoholics Anonymous meetings near you`} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    <meta name="twitter:image:alt" content={`AA Meetings in ${LOCATION.city} - Find Alcoholics Anonymous meetings near you`} />

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
      {JSON.stringify({
        '@context': 'https://schema.org',
        '@graph': [
          {
            '@type': 'WebPage',
            '@id': canonical,
            'url': canonical,
            'name': title,
            'description': description,
            'isPartOf': {
              '@type': 'WebSite',
              'name': siteName,
              'url': 'https://gskis.com'
            },
            'about': {
              '@type': 'Thing',
              'name': 'Alcoholics Anonymous',
              'sameAs': 'https://www.aa.org'
            },
            'mainEntity': {
              '@type': 'ItemList',
              'name': `AA Meetings in ${LOCATION.city}`,
              'description': `List of Alcoholics Anonymous meetings in ${LOCATION.city}, ${LOCATION.stateFull}`,
              'numberOfItems': normalizedMeetings.length,
              'itemListElement': normalizedMeetings.slice(0, 10).map((m, i) => ({
                '@type': 'ListItem',
                'position': i + 1,
                'item': {
                  '@type': 'Event',
                  'name': m.name,
                  'description': `${m.types_array?.join(', ') || 'AA'} meeting`,
                  'location': {
                    '@type': 'Place',
                    'name': m.location || m.display_address,
                    'address': m.display_address
                  },
                  'eventSchedule': {
                    '@type': 'Schedule',
                    'byDay': m.display_day,
                    'startTime': m.time
                  }
                }
              }))
            }
          },
          {
            '@type': 'Place',
            'name': `${LOCATION.city}, ${LOCATION.stateFull}`,
            'geo': {
              '@type': 'GeoCoordinates',
              'latitude': locationLat,
              'longitude': locationLng
            },
            'address': {
              '@type': 'PostalAddress',
              'addressLocality': LOCATION.city,
              'addressRegion': LOCATION.stateAbbr,
              'addressCountry': 'US'
            }
          },
          {
            '@type': 'BreadcrumbList',
            'itemListElement': [
              {
                '@type': 'ListItem',
                'position': 1,
                'name': 'Home',
                'item': 'https://gskis.com'
              },
              {
                '@type': 'ListItem',
                'position': 2,
                'name': 'Meetings',
                'item': 'https://gskis.com/meetings'
              },
              {
                '@type': 'ListItem',
                'position': 3,
                'name': LOCATION.city,
                'item': canonical
              }
            ]
          },
          {
            '@type': 'FAQPage',
            'mainEntity': [
              {
                '@type': 'Question',
                'name': `How many AA meetings are in ${LOCATION.city}?`,
                'acceptedAnswer': {
                  '@type': 'Answer',
                  'text': `There are over ${normalizedMeetings.length} AA meetings available in and around the ${LOCATION.city} area, with meetings held every day of the week at various times.`
                }
              },
              {
                '@type': 'Question',
                'name': `What types of AA meetings are available in ${LOCATION.city}?`,
                'acceptedAnswer': {
                  '@type': 'Answer',
                  'text': `${LOCATION.city} offers a variety of AA meeting types including Open meetings (anyone can attend), Closed meetings (for those with a desire to stop drinking), Speaker meetings, Discussion meetings, Big Book study, Step meetings, and specialty meetings for men, women, and young people.`
                }
              },
              {
                '@type': 'Question',
                'name': `Are there AA meetings in ${LOCATION.city} every day?`,
                'acceptedAnswer': {
                  '@type': 'Answer',
                  'text': `Yes, AA meetings are held in ${LOCATION.city} every day of the week, including weekends and holidays. Meetings are available in the morning, afternoon, evening, and night.`
                }
              }
            ]
          }
        ]
      })}
    </script>

    <style is:global>
      @font-face {
        font-family: 'SF Pro Display';
        src: url('/fonts/SFPRODISPLAYREGULAR.OTF') format('opentype');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }

      @font-face {
        font-family: 'SF Pro Display';
        src: url('/fonts/SFPRODISPLAYBOLD.OTF') format('opentype');
        font-weight: bold;
        font-style: normal;
        font-display: swap;
      }

      * {
        box-sizing: border-box;
      }

      html, body {
        font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #F8F9FA;
        color: #222;
      }

      .container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
      }

      /* Header Section */
      .header {
        margin-bottom: 2rem;
      }

      .header-title {
        font-size: 2.2rem;
        font-weight: bold;
        color: #2a3a4d;
        margin: 0 0 0.5rem 0;
        line-height: 1.2;
      }

      .header-subtitle {
        font-size: 1.1rem;
        color: #6b7280;
        margin: 0 0 1.5rem 0;
        max-width: 700px;
        line-height: 1.5;
      }

      .cta-button {
        display: inline-flex;
        align-items: center;
        gap: 0.8rem;
        background: #2A9D8F;
        color: white;
        padding: 0.75rem 1.25rem;
        border-radius: 12px;
        text-decoration: none;
        font-weight: 500;
        transition: background 0.2s;
      }

      .cta-button:hover {
        background: #21867A;
      }

      .app-store-text {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        line-height: 1.2;
      }

      .app-store-text .small {
        font-size: 0.75rem;
        opacity: 0.9;
      }

      .app-store-text .large {
        font-size: 0.95rem;
        font-weight: 600;
      }

      /* Section Cards */
      .section-card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0 0 1rem 0;
        color: #2a3a4d;
      }

      /* Filter Controls */
      .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
      }

      .filter-label {
        font-size: 0.85rem;
        font-weight: 500;
        color: #6b7280;
      }

      .filter-select {
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 0.95rem;
        font-family: inherit;
        background: #fff;
        color: #2a3a4d;
        min-width: 140px;
        cursor: pointer;
        transition: border-color 0.2s;
      }

      .filter-select:hover {
        border-color: #2A9D8F;
      }

      .filter-select:focus {
        outline: none;
        border-color: #2A9D8F;
        box-shadow: 0 0 0 3px rgba(42, 157, 143, 0.1);
      }

      .results-count {
        font-size: 0.95rem;
        color: #6b7280;
        margin-left: auto;
      }

      /* Map */
      #meeting-map {
        width: 100%;
        height: 450px;
        border-radius: 12px;
        overflow: hidden;
      }

      /* Meeting List */
      .meeting-list {
        display: grid;
        gap: 1rem;
      }

      .meeting-card {
        background: #fff;
        border-radius: 12px;
        padding: 1.25rem;
        box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        border: 1px solid #e5e7eb;
        transition: box-shadow 0.2s, border-color 0.2s;
      }

      .meeting-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border-color: #2A9D8F;
      }

      .meeting-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2a3a4d;
        margin: 0 0 0.5rem 0;
      }

      .meeting-info {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        font-size: 0.95rem;
        color: #4a5a6a;
        margin-bottom: 0.75rem;
      }

      .meeting-info-item {
        display: flex;
        align-items: center;
        gap: 0.35rem;
      }

      .meeting-info-item svg {
        width: 16px;
        height: 16px;
        color: #6b7280;
      }

      .meeting-address {
        font-size: 0.9rem;
        color: #6b7280;
        margin-bottom: 0.75rem;
      }

      /* Type Badges */
      .meeting-types {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
      }

      .type-badge {
        color: #2a3a4d;
        font-size: 0.8rem;
        padding: 0.2em 0.6em;
        border-radius: 6px;
        font-weight: 500;
        background: #e0e7ef;
      }

      .type-badge-beginner { background: rgba(34,197,94,0.2); color: #16a34a; }
      .type-badge-bigbook { background: rgba(20,184,166,0.2); color: #0d9488; }
      .type-badge-closed { background: rgba(239,68,68,0.2); color: #dc2626; }
      .type-badge-discussion { background: rgba(251,146,60,0.2); color: #ea580c; }
      .type-badge-english, .type-badge-grapevine, .type-badge-literature, .type-badge-step, .type-badge-steptradition, .type-badge-tradition, .type-badge-wheelchair { background: rgba(209,213,219,0.4); color: #374151; }
      .type-badge-men { background: rgba(37,99,235,0.2); color: #2563eb; }
      .type-badge-open { background: rgba(6,182,212,0.2); color: #0891b2; }
      .type-badge-speaker { background: rgba(153,246,228,0.3); color: #0d9488; }
      .type-badge-women { background: rgba(236,72,153,0.2); color: #db2777; }
      .type-badge-youngpeople { background: rgba(253,224,71,0.3); color: #ca8a04; }

      /* Meeting Actions */
      .meeting-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #f3f4f6;
      }

      .btn-small {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        background: #f0f6ff;
        color: #5A7D9A;
        border: 1px solid #5A7D9A;
        border-radius: 6px;
        padding: 0.35rem 0.7rem;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        text-decoration: none;
        transition: background 0.15s, color 0.15s;
      }

      .btn-small:hover {
        background: #5A7D9A;
        color: #fff;
      }

      .btn-small svg {
        width: 14px;
        height: 14px;
      }

      /* No Results */
      .no-results {
        text-align: center;
        padding: 3rem;
        color: #6b7280;
      }

      .no-results-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
      }

      /* SEO Content */
      .seo-content {
        margin-top: 2rem;
      }

      .seo-text {
        color: #4a5a6a;
        line-height: 1.7;
      }

      .seo-text p {
        margin: 0 0 1rem 0;
      }

      .seo-text h3 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2a3a4d;
        margin: 1.5rem 0 0.75rem 0;
      }

      .seo-text strong {
        color: #2a3a4d;
      }

      /* App Promo Banner */
      .app-promo {
        background: linear-gradient(135deg, #2A9D8F 0%, #1d7a6f 100%);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        color: white;
        display: flex;
        align-items: center;
        gap: 2rem;
      }

      .app-promo-content {
        flex: 1;
      }

      .app-promo-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0 0 0.5rem 0;
      }

      .app-promo-subtitle {
        font-size: 1rem;
        opacity: 0.95;
        margin: 0 0 1rem 0;
        line-height: 1.5;
      }

      .app-promo-features {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .app-promo-feature {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
      }

      .app-promo-feature svg {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
      }

      .cta-button-large {
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        background: white;
        color: #2A9D8F;
        padding: 0.875rem 1.5rem;
        border-radius: 12px;
        text-decoration: none;
        font-weight: 600;
        font-size: 1rem;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 14px rgba(0,0,0,0.15);
      }

      .cta-button-large:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      }

      .app-promo-rating {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1rem;
        font-size: 0.9rem;
      }

      .stars {
        color: #fbbf24;
        letter-spacing: 2px;
      }

      /* Feature Grid */
      .feature-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-top: 1rem;
      }

      .feature-item {
        text-align: center;
        padding: 1.5rem 1rem;
      }

      .feature-icon {
        width: 48px;
        height: 48px;
        background: rgba(42, 157, 143, 0.1);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        color: #2A9D8F;
      }

      .feature-icon svg {
        width: 24px;
        height: 24px;
      }

      .feature-title {
        font-weight: 600;
        color: #2a3a4d;
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
      }

      .feature-desc {
        font-size: 0.9rem;
        color: #6b7280;
        margin: 0;
        line-height: 1.5;
      }

      /* Final CTA Section */
      .final-cta {
        background: #fff;
        border-radius: 16px;
        padding: 3rem 2rem;
        text-align: center;
        margin-top: 2rem;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      }

      .final-cta-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: #2a3a4d;
        margin: 0 0 0.75rem 0;
      }

      .final-cta-subtitle {
        font-size: 1.1rem;
        color: #6b7280;
        margin: 0 0 1.5rem 0;
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
      }

      .cta-button-hero {
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        background: #2A9D8F;
        color: white;
        padding: 1rem 2rem;
        border-radius: 14px;
        text-decoration: none;
        font-weight: 600;
        font-size: 1.1rem;
        transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
        box-shadow: 0 4px 14px rgba(42, 157, 143, 0.4);
      }

      .cta-button-hero:hover {
        background: #21867A;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(42, 157, 143, 0.5);
      }

      .trust-badges {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
      }

      .trust-badge {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        color: #6b7280;
      }

      .trust-badge svg {
        width: 18px;
        height: 18px;
        color: #2A9D8F;
      }

      /* Sticky Mobile CTA */
      .sticky-cta {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 1rem;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        z-index: 100;
        border-top: 1px solid #e5e7eb;
      }

      .sticky-cta-inner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        max-width: 1100px;
        margin: 0 auto;
        gap: 1rem;
      }

      .sticky-cta-text {
        flex: 1;
      }

      .sticky-cta-title {
        font-weight: 600;
        font-size: 0.95rem;
        color: #2a3a4d;
        margin: 0;
      }

      .sticky-cta-subtitle {
        font-size: 0.8rem;
        color: #6b7280;
        margin: 0;
      }

      .sticky-cta-button {
        background: #2A9D8F;
        color: white;
        padding: 0.75rem 1.25rem;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.9rem;
        white-space: nowrap;
        transition: background 0.2s;
      }

      .sticky-cta-button:hover {
        background: #21867A;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .container {
          padding: 1rem;
          padding-bottom: 100px;
        }

        .sticky-cta {
          display: block;
        }

        .app-promo {
          flex-direction: column;
          text-align: center;
          padding: 1.5rem;
        }

        .app-promo-features {
          justify-content: center;
        }

        .final-cta {
          padding: 2rem 1.5rem;
        }

        .final-cta-title {
          font-size: 1.4rem;
        }

        .header-title {
          font-size: 1.6rem;
        }

        .header-subtitle {
          font-size: 1rem;
        }

        .filters {
          flex-direction: column;
          align-items: stretch;
        }

        .filter-group {
          width: 100%;
        }

        .filter-select {
          width: 100%;
        }

        .results-count {
          margin-left: 0;
          margin-top: 0.5rem;
        }

        #meeting-map {
          height: 350px;
        }

        .section-card {
          padding: 1rem;
        }

        .meeting-card {
          padding: 1rem;
        }

        .meeting-actions {
          flex-wrap: wrap;
        }
      }

      @media (min-width: 769px) {
        .sticky-cta {
          display: none !important;
        }
      }
    </style>

    <!-- Leaflet CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  </head>
  <body>
    <main class="container">
      <!-- Header -->
      <header class="header">
        <h1 class="header-title">AA Meetings in {LOCATION.city}, {LOCATION.stateFull}</h1>
        <p class="header-subtitle">Find Alcoholics Anonymous meetings near you in the {LOCATION.areaDescription}. Browse open meetings, closed meetings, speaker meetings, and more. Filter by day, time, or meeting type to find the perfect meeting for your recovery journey.</p>
      </header>

      <!-- App Promo Banner -->
      <section class="app-promo" aria-labelledby="app-promo-heading">
        <div class="app-promo-content">
          <h2 id="app-promo-heading" class="app-promo-title">Get the MyMeetings App</h2>
          <p class="app-promo-subtitle">The world's best meeting finder for AA. Quickly find meetings, track attendance, and stay connected on your recovery journey.</p>
          <div class="app-promo-features">
            <div class="app-promo-feature">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
              <span>Largest Collection of AA Meetings</span>
            </div>
            <div class="app-promo-feature">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
              <span>Easy to Use</span>
            </div>
            <div class="app-promo-feature">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
              <span>Advanced Analytics</span>
            </div>
            <div class="app-promo-feature">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
              <span>AI Insights</span>
            </div>
          </div>
          <a href={appStoreUrl} target="_blank" class="cta-button-large" rel="noopener noreferrer">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
            </svg>
            Download Free on App Store
          </a>
          <div class="app-promo-rating">
            <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
            <span>4.9 rating ¬∑ Free download</span>
          </div>
        </div>
      </section>

      <!-- Filters -->
      <section class="section-card" aria-labelledby="filter-heading">
        <h2 id="filter-heading" class="section-title">Filter AA Meetings</h2>
        <div class="filters">
          <div class="filter-group">
            <label class="filter-label" for="filter-day">Day of Week</label>
            <select id="filter-day" class="filter-select">
              <option value="">All Days</option>
              <option value="0">Sunday</option>
              <option value="1">Monday</option>
              <option value="2">Tuesday</option>
              <option value="3">Wednesday</option>
              <option value="4">Thursday</option>
              <option value="5">Friday</option>
              <option value="6">Saturday</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label" for="filter-time">Time of Day</label>
            <select id="filter-time" class="filter-select">
              <option value="">All Times</option>
              <option value="morning">Morning (6am - 12pm)</option>
              <option value="afternoon">Afternoon (12pm - 5pm)</option>
              <option value="evening">Evening (5pm - 9pm)</option>
              <option value="night">Night (9pm - 6am)</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label" for="filter-type">Meeting Type</label>
            <select id="filter-type" class="filter-select">
              <option value="">All Types</option>
              <option value="Open">Open</option>
              <option value="Closed">Closed</option>
              <option value="Speaker">Speaker</option>
              <option value="Discussion">Discussion</option>
              <option value="Big Book">Big Book</option>
              <option value="Step">Step</option>
              <option value="Beginner">Beginner</option>
              <option value="Men">Men</option>
              <option value="Women">Women</option>
              <option value="Young People">Young People</option>
            </select>
          </div>
          <span id="results-count" class="results-count" aria-live="polite">{normalizedMeetings.length} meetings found</span>
        </div>
      </section>

      <!-- Map Section -->
      <section class="section-card" aria-labelledby="map-heading">
        <h2 id="map-heading" class="section-title">AA Meeting Locations in {LOCATION.city}</h2>
        <div id="meeting-map" data-lat={locationLat} data-lng={locationLng} role="application" aria-label={`Interactive map showing AA meeting locations in ${LOCATION.city}`}></div>
      </section>

      <!-- Meetings Data -->
      <script id="initial-meetings" type="application/json" set:html={initialMeetingsJSON}></script>

      <!-- Meetings List -->
      <section class="section-card" aria-labelledby="meetings-heading">
        <h2 id="meetings-heading" class="section-title">Alcoholics Anonymous Meetings Near {LOCATION.city}</h2>
        <div id="meeting-list" class="meeting-list">
          {normalizedMeetings && normalizedMeetings.length > 0 ? (
            normalizedMeetings.slice(0, 50).map((m: any) => (
              <div class="meeting-card" data-day={m.day} data-time={m.time} data-types={m.types || ''}>
                <h3 class="meeting-name">{m.name}</h3>
                <div class="meeting-info">
                  <span class="meeting-info-item">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    {m.display_day}
                  </span>
                  <span class="meeting-info-item">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    {m.display_time}
                  </span>
                </div>
                {m.display_address && (
                  <div class="meeting-address">
                    <svg style="display:inline;width:14px;height:14px;vertical-align:-2px;margin-right:4px;" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    {m.display_address}
                  </div>
                )}
                {m.types_array && m.types_array.length > 0 && (
                  <div class="meeting-types">
                    {m.types_array.map((type: string) => (
                      <span class={`type-badge ${typeToClass[type] || ''}`}>{type}</span>
                    ))}
                  </div>
                )}
                {(m.latitude && m.longitude) && (
                  <div class="meeting-actions">
                    <a class="btn-small" href={`http://maps.apple.com/?daddr=${m.latitude},${m.longitude}`} target="_blank" rel="noopener noreferrer">
                      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" /></svg>
                      Directions
                    </a>
                  </div>
                )}
              </div>
            ))
          ) : (
            <div class="no-results">
              <div class="no-results-icon">üìç</div>
              <p>No meetings found. Please try adjusting your filters.</p>
            </div>
          )}
        </div>
      </section>

      <!-- SEO Content Section -->
      <section class="section-card seo-content" aria-labelledby="about-heading">
        <h2 id="about-heading" class="section-title">About AA Meetings in {LOCATION.city}</h2>
        <div class="seo-text">
          <p>Alcoholics Anonymous (AA) meetings in {LOCATION.city} provide a supportive community for individuals seeking recovery from alcohol addiction. Whether you're new to recovery or have been sober for years, {LOCATION.city}'s AA community welcomes you with open arms.</p>
          
          <h3>Types of AA Meetings Available</h3>
          <p><strong>Open Meetings:</strong> Anyone interested in learning about AA can attend, including family members, friends, and those curious about the program.</p>
          <p><strong>Closed Meetings:</strong> Reserved for individuals who have a desire to stop drinking. These meetings offer a more intimate setting for sharing.</p>
          <p><strong>Speaker Meetings:</strong> One or more members share their experience, strength, and hope with the group.</p>
          <p><strong>Discussion Meetings:</strong> Members discuss a topic related to recovery, with everyone having an opportunity to share.</p>
          <p><strong>Big Book/Step Study:</strong> Focused study of AA literature including the Big Book and the 12 Steps.</p>
          
          <h3>Finding the Right Meeting</h3>
          <p>Use the filters above to find meetings that fit your schedule and preferences. Meetings are available throughout {LOCATION.areaDescription} including {LOCATION.neighborhoods}.</p>
          
          <h3>Need Help Getting Started?</h3>
          <p>Download the <strong>MyMeetings app</strong> for the best experience finding and tracking AA meetings. Save your favorite meetings, get reminders, and access meeting information offline.</p>
        </div>
      </section>

      <!-- Why Choose MyMeetings -->
      <section class="section-card" aria-labelledby="features-heading">
        <h2 id="features-heading" class="section-title">Why Choose MyMeetings?</h2>
        <div class="feature-grid">
          <div class="feature-item">
            <div class="feature-icon">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            </div>
            <h3 class="feature-title">Find Meetings Fast</h3>
            <p class="feature-desc">Search by location, day, time, or meeting type. Find the perfect meeting in seconds.</p>
          </div>
          <div class="feature-item">
            <div class="feature-icon">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
            </div>
            <h3 class="feature-title">Save Favorites</h3>
            <p class="feature-desc">Bookmark your go-to meetings for quick access anytime, anywhere.</p>
          </div>
          <div class="feature-item">
            <div class="feature-icon">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
            </div>
            <h3 class="feature-title">Never Miss a Meeting</h3>
            <p class="feature-desc">Set reminders so you're always on time for your meetings.</p>
          </div>
          <div class="feature-item">
            <div class="feature-icon">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
            </div>
            <h3 class="feature-title">Private & Secure</h3>
            <p class="feature-desc">Your recovery journey is private. We never share your data.</p>
          </div>
        </div>
      </section>

      <!-- Final CTA -->
      <section class="final-cta" aria-labelledby="final-cta-heading">
        <h2 id="final-cta-heading" class="final-cta-title">Ready to Find Your Next Meeting?</h2>
        <p class="final-cta-subtitle">Join thousands in recovery using MyMeetings to stay connected with the AA community.</p>
        <a href={appStoreUrl} target="_blank" class="cta-button-hero" rel="noopener noreferrer">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
          </svg>
          Download MyMeetings ‚Äî It's Free
        </a>
        <div class="trust-badges">
          <div class="trust-badge">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
            <span>100% Free</span>
          </div>
          <div class="trust-badge">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
            <span>Private & Secure</span>
          </div>
          <div class="trust-badge">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
            <span>4.9‚òÖ Rating</span>
          </div>
        </div>
      </section>
    </main>

    <!-- Sticky Mobile CTA -->
    <div class="sticky-cta" id="sticky-cta">
      <div class="sticky-cta-inner">
        <div class="sticky-cta-text">
          <p class="sticky-cta-title">MyMeetings App</p>
          <p class="sticky-cta-subtitle">Find meetings faster</p>
        </div>
        <a href={appStoreUrl} target="_blank" class="sticky-cta-button" rel="noopener noreferrer">
          Get the App
        </a>
      </div>
    </div>

    <!-- Client-side filtering and map logic -->
    <script>
      (function() {
        function formatTime(t) {
          if (!t) return '';
          const parts = String(t).split(':');
          if (parts.length < 2) return t;
          const hour = parseInt(parts[0], 10);
          const minute = parts[1];
          const ampm = hour >= 12 ? 'PM' : 'AM';
          const hour12 = hour % 12 === 0 ? 12 : hour % 12;
          return `${hour12}:${minute} ${ampm}`;
        }

        function dayOfWeek(num) {
          const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
          return days[(Number(num) || 0)];
        }

        function getTimeOfDay(timeStr) {
          if (!timeStr) return null;
          const parts = String(timeStr).split(':');
          const hour = parseInt(parts[0], 10);
          if (hour >= 6 && hour < 12) return 'morning';
          if (hour >= 12 && hour < 17) return 'afternoon';
          if (hour >= 17 && hour < 21) return 'evening';
          return 'night';
        }

        let allMeetings = [];
        let map = null;
        let markers = [];

        function init() {
          if (typeof window === 'undefined') return;
          if (typeof L === 'undefined') {
            setTimeout(init, 150);
            return;
          }

          // Load meetings data
          try {
            const dataEl = document.getElementById('initial-meetings');
            allMeetings = JSON.parse(dataEl?.textContent || '[]') || [];
          } catch (err) {
            console.error('Failed to read meetings JSON', err);
            allMeetings = [];
          }

          // Initialize map
          const mapEl = document.getElementById('meeting-map');
          const lat = parseFloat(mapEl?.dataset.lat || '42.3601');
          const lng = parseFloat(mapEl?.dataset.lng || '-71.0589');
          map = L.map('meeting-map').setView([lat, lng], 12);

          L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap contributors, ¬© CartoDB'
          }).addTo(map);

          // Render initial markers
          renderMarkers(allMeetings);

          // Set up filter listeners
          const filterDay = document.getElementById('filter-day');
          const filterTime = document.getElementById('filter-time');
          const filterType = document.getElementById('filter-type');

          [filterDay, filterTime, filterType].forEach(el => {
            el?.addEventListener('change', applyFilters);
          });
        }

        function applyFilters() {
          const dayVal = document.getElementById('filter-day')?.value;
          const timeVal = document.getElementById('filter-time')?.value;
          const typeVal = document.getElementById('filter-type')?.value;

          const filtered = allMeetings.filter(m => {
            // Day filter
            if (dayVal && String(m.day) !== dayVal) return false;

            // Time of day filter
            if (timeVal && getTimeOfDay(m.time) !== timeVal) return false;

            // Type filter
            if (typeVal) {
              const types = m.types ? String(m.types).toLowerCase() : '';
              if (!types.includes(typeVal.toLowerCase())) return false;
            }

            return true;
          });

          // Update count
          const countEl = document.getElementById('results-count');
          if (countEl) countEl.textContent = `${filtered.length} meetings found`;

          // Update list
          renderList(filtered);

          // Update map markers
          renderMarkers(filtered);
        }

        function renderList(meetings) {
          const listEl = document.getElementById('meeting-list');
          if (!listEl) return;

          if (meetings.length === 0) {
            listEl.innerHTML = `
              <div class="no-results">
                <div class="no-results-icon">üìç</div>
                <p>No meetings found. Please try adjusting your filters.</p>
              </div>
            `;
            return;
          }

          const typeToClass = {
            'Beginner': 'type-badge-beginner',
            'Big Book': 'type-badge-bigbook',
            'Closed': 'type-badge-closed',
            'Discussion': 'type-badge-discussion',
            'English': 'type-badge-english',
            'Grapevine': 'type-badge-grapevine',
            'Literature': 'type-badge-literature',
            'Men': 'type-badge-men',
            'Open': 'type-badge-open',
            'Step': 'type-badge-step',
            'Speaker': 'type-badge-speaker',
            'Step/Tradition': 'type-badge-steptradition',
            'Tradition': 'type-badge-tradition',
            'Women': 'type-badge-women',
            'Wheelchair Access': 'type-badge-wheelchair',
            'Young People': 'type-badge-youngpeople',
          };

          listEl.innerHTML = meetings.slice(0, 50).map(m => {
            const types = m.types ? String(m.types).split(',').map(t => t.trim()).filter(Boolean) : [];
            const typeBadges = types.map(t => `<span class="type-badge ${typeToClass[t] || ''}">${t}</span>`).join('');
            const displayDay = m.display_day || (m.day != null ? dayOfWeek(m.day) : '');
            const displayTime = m.display_time || (m.time ? formatTime(m.time) : '');
            const displayAddress = m.display_address || m.formatted_address || m.location || m.address || '';

            let actionsHtml = '';
            if (m.latitude && m.longitude) {
              actionsHtml = `
                <div class="meeting-actions">
                  <a class="btn-small" href="http://maps.apple.com/?daddr=${m.latitude},${m.longitude}" target="_blank" rel="noopener noreferrer">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" /></svg>
                    Directions
                  </a>
                </div>
              `;
            }

            return `
              <div class="meeting-card">
                <h3 class="meeting-name">${m.name || 'Unnamed Meeting'}</h3>
                <div class="meeting-info">
                  <span class="meeting-info-item">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    ${displayDay}
                  </span>
                  <span class="meeting-info-item">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    ${displayTime}
                  </span>
                </div>
                ${displayAddress ? `<div class="meeting-address"><svg style="display:inline;width:14px;height:14px;vertical-align:-2px;margin-right:4px;" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>${displayAddress}</div>` : ''}
                ${typeBadges ? `<div class="meeting-types">${typeBadges}</div>` : ''}
                ${actionsHtml}
              </div>
            `;
          }).join('');
        }

        function renderMarkers(meetings) {
          // Clear existing markers
          markers.forEach(m => map.removeLayer(m));
          markers = [];

          meetings.forEach(m => {
            const lat = m.latitude != null ? Number(m.latitude) : (m.lat != null ? Number(m.lat) : null);
            const lng = m.longitude != null ? Number(m.longitude) : (m.lng != null ? Number(m.lng) : null);
            if (!isFinite(lat) || !isFinite(lng)) return;

            const displayDay = m.display_day || (m.day != null ? dayOfWeek(m.day) : '');
            const displayTime = m.display_time || (m.time ? formatTime(m.time) : '');
            const displayAddress = m.display_address || m.formatted_address || m.location || m.address || '';

            const popupParts = [];
            if (m.name) popupParts.push(`<strong>${String(m.name)}</strong>`);
            if (displayAddress) popupParts.push(displayAddress);
            if (displayTime) popupParts.push(`${displayTime}${displayDay ? ` ‚Ä¢ ${displayDay}` : ''}`);

            const marker = L.marker([lat, lng]).addTo(map).bindPopup(popupParts.join('<br/>'));
            markers.push(marker);
          });
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
      })();
    </script>

    <!-- Mixpanel Tracking -->
    <script>
      import { track } from 'astrojs-mixpanel/client';
      document.addEventListener('DOMContentLoaded', function () {
        // Track all CTA button clicks
        const ctaButtons = document.querySelectorAll('.cta-button, .cta-button-large, .cta-button-hero, .sticky-cta-button');
        ctaButtons.forEach(function(btn, index) {
          btn.addEventListener('click', function () {
            try {
              // Determine button location based on class or position
              let location = 'unknown';
              if (btn.classList.contains('sticky-cta-button')) location = 'sticky_mobile';
              else if (btn.classList.contains('cta-button-hero')) location = 'final_cta';
              else if (btn.classList.contains('cta-button-large')) location = 'app_promo_banner';
              else if (btn.classList.contains('cta-button')) location = 'header';
              
              track('App Download Click', {
                page: 'meetings_boston',
                button_location: location,
                button_index: index,
                url: window.location.href,
                referrer: document.referrer || 'direct'
              });
            } catch (e) {
              console.warn('Mixpanel track failed', e);
            }
          });
        });

        // Track scroll depth
        let maxScroll = 0;
        const trackScrollDepth = function() {
          const scrollPercent = Math.round((window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100);
          if (scrollPercent > maxScroll && scrollPercent % 25 === 0) {
            maxScroll = scrollPercent;
            try {
              track('Scroll Depth', {
                page: 'meetings_boston',
                depth: scrollPercent
              });
            } catch (e) {}
          }
        };
        window.addEventListener('scroll', trackScrollDepth, { passive: true });

        // Track filter usage
        const filters = document.querySelectorAll('.filter-select');
        filters.forEach(function(filter) {
          filter.addEventListener('change', function() {
            try {
              track('Filter Used', {
                page: 'meetings_boston',
                filter_type: filter.id.replace('filter-', ''),
                filter_value: filter.value || 'all'
              });
            } catch (e) {}
          });
        });

        // Track time on page for engaged users
        setTimeout(function() {
          try {
            track('Engaged User', {
              page: 'meetings_boston',
              time_on_page: '30s'
            });
          } catch (e) {}
        }, 30000);
      });
    </script>
  </body>
</html>
