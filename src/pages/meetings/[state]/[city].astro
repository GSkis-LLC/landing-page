---
import { getAllLocations, getLocation, toSlug, getCitiesInState } from '../../../data/location-store';
import type { LocationConfig } from '../../../data/location-store';

// Component imports
import Header from '../../../components/Header.astro';
import MeetingHeader from '../../../components/meetings/MeetingHeader.astro';
import AppPromo from '../../../components/meetings/AppPromo.astro';
import MeetingList from '../../../components/meetings/MeetingList.astro';
import MeetingStats from '../../../components/meetings/MeetingStats.astro';
import LocalResources from '../../../components/meetings/LocalResources.astro';
import SEOContent from '../../../components/meetings/SEOContent.astro';
import FeatureGrid from '../../../components/meetings/FeatureGrid.astro';
import FinalCTA from '../../../components/meetings/FinalCTA.astro';
import StickyCTA from '../../../components/meetings/StickyCTA.astro';
import Filters from '../../../components/meetings/Filters.astro';
import NearbyLocations from '../../../components/meetings/NearbyLocations.astro';
import '../../../styles/global.css';

// Enable static prerendering for all locations
export const prerender = true;

// Generate static paths for all locations
export function getStaticPaths() {
  const locations = getAllLocations();
  return locations.map((loc) => ({
    params: {
      state: loc.stateSlug,
      city: loc.citySlug,
    },
    props: { location: loc },
  }));
}

// Get location from props (passed from getStaticPaths)
const { location } = Astro.props;
const LOCATION = location as LocationConfig & { stateSlug: string; citySlug: string };

// Fallback lookup if props not available (shouldn't happen with SSG)
if (!LOCATION) {
  return Astro.redirect('/meetings');
}

// ============================================================================
// DERIVED CONSTANTS (auto-generated from LOCATION config)
// ============================================================================
const stateSlug = toSlug(LOCATION.stateFull);
const citySlug = toSlug(LOCATION.city);
const title = `AA Meetings near ${LOCATION.city}, ${LOCATION.stateAbbr} - Find Alcoholics Anonymous Near You`;
const description = `Find AA Meetings near ${LOCATION.city}, ${LOCATION.stateFull}. Browse from hundreds of local Alcoholics Anonymous meetings by times, locations, types, and more. Serving the ${LOCATION.neighborhoods} areas and beyond, MyMeetings is the #1 AA meeting finder`;
const canonical = `https://gskis.com/meetings/${stateSlug}/${citySlug}`;
const appStoreUrl = 'https://apps.apple.com/app/id6748364894';
const locationLat = LOCATION.lat;
const locationLng = LOCATION.lng;

// SEO-related constants
const siteName = 'MyMeetings';
const ogImage = `https://gskis.com/myMeetingsAppLogo.webp`;
const keywords = `AA meetings ${LOCATION.city}, AA meetings ${LOCATION.neighborhoods}, Alcoholics Anonymous ${LOCATION.city}, AA near me, ${LOCATION.city} AA meetings, recovery meetings ${LOCATION.city}, 12 step meetings ${LOCATION.city}, AA meeting times ${LOCATION.city}, open AA meetings ${LOCATION.city}, closed AA meetings ${LOCATION.city}`;

let meetings: any[] = [];
let organizations: any[] = [];
try {
  const res = await fetch(`https://api.meetingguide.org/app/v2/request?latitude=${locationLat}&longitude=${locationLng}`);
  if (res.ok) {
    const json = await res.json();
    meetings = json?.meetings ?? json ?? [];
    organizations = json?.organizations ?? [];
  } else {
    console.error('Meetings fetch failed', res.status);
  }
} catch (e) {
  console.error(e);
}

function formatTime(t: any) {
  if (!t) return '';
  const [h, m] = String(t).split(':');
  const hour = parseInt(h || '0', 10);
  const ampm = hour >= 12 ? 'PM' : 'AM';
  const hour12 = hour % 12 === 0 ? 12 : hour % 12;
  return `${hour12}:${m || '00'} ${ampm}`;
}

function dayOfWeek(num: any) {
  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  return days[Number(num) || 0];
}

// Map meeting type to CSS class
const typeToClass: Record<string, string> = {
  'Beginner': 'type-badge-beginner',
  'Big Book': 'type-badge-bigbook',
  'Closed': 'type-badge-closed',
  'Discussion': 'type-badge-discussion',
  'English': 'type-badge-english',
  'Grapevine': 'type-badge-grapevine',
  'Literature': 'type-badge-literature',
  'Men': 'type-badge-men',
  'Open': 'type-badge-open',
  'Step': 'type-badge-step',
  'Speaker': 'type-badge-speaker',
  'Step/Tradition': 'type-badge-steptradition',
  'Tradition': 'type-badge-tradition',
  'Women': 'type-badge-women',
  'Wheelchair Access': 'type-badge-wheelchair',
  'Young People': 'type-badge-youngpeople',
};

const normalizedMeetings = (meetings || []).map((m: any) => ({
  ...m,
  latitude: m.latitude ? Number(m.latitude) : m.lat ? Number(m.lat) : null,
  longitude: m.longitude ? Number(m.longitude) : m.lng ? Number(m.lng) : null,
  display_time: m.time ? formatTime(m.time) : '',
  display_day: m.day != null ? dayOfWeek(m.day) : '',
  display_address: m.formatted_address || m.location || m.address || '',
  types_array: m.types ? String(m.types).split(',').map((t: string) => t.trim()).filter(Boolean) : [],
  // Notes fields
  notes: m.notes || null,
  group_notes: m.group_notes || null,
  location_notes: m.location_notes || null,
  // Conference/video call fields
  conference_url: m.conference_url || null,
  conference_url_notes: m.conference_url_notes || null,
  conference_phone: m.conference_phone || null,
  conference_phone_notes: m.conference_phone_notes || null,
}));

// Calculate top 3 popular meeting locations (excluding online meetings)
const locationCounts = new Map();
normalizedMeetings.forEach(meeting => {
  const location = meeting.location;
  if (location && location.toLowerCase() !== 'online') {
    const count = locationCounts.get(location) || 0;
    locationCounts.set(location, count + 1);
  }
});

const topLocations = Array.from(locationCounts.entries())
  .sort(([,a], [,b]) => b - a)
  .slice(0, 3)
  .map(([location, count]) => {
    // Find a meeting with this location to get formatted_address
    const meeting = normalizedMeetings.find(m => m.location === location);
    return {
      location,
      count,
      formatted_address: meeting?.formatted_address || meeting?.display_address || ''
    };
  });

const initialMeetingsJSON = JSON.stringify(normalizedMeetings).replace(/</g, '\u003c');
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/x-icon" href="/myMeetings.ico" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonical} />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <!-- iOS Smart App Banner -->
    <meta name="apple-itunes-app" content={`app-id=6748364894, app-argument=mymeetings://meetings/${stateSlug}/${citySlug}`} />
    
    <!-- Additional SEO Meta Tags -->
    <meta name="robots" content="index, follow" />
    <meta name="googlebot" content="index, follow" />
    <meta name="keywords" content={keywords} />
    <meta name="author" content="MyMeetings" />
    <meta name="application-name" content="MyMeetings" />
    <meta name="msapplication-TileColor" content="#2A9D8F" />
    <meta name="geo.region" content={LOCATION.geoRegion} />
    <meta name="geo.placename" content={LOCATION.city} />
    <meta name="geo.position" content={`${LOCATION.lat};${LOCATION.lng}`} />
    <meta name="ICBM" content={`${LOCATION.lat}, ${LOCATION.lng}`} />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonical} />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:locale" content="en_US" />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content={`AA Meetings near ${LOCATION.city} - Find Alcoholics Anonymous meetings near you`} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    <meta name="twitter:image:alt" content={`AA Meetings near ${LOCATION.city} - Find Alcoholics Anonymous meetings near you`} />

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@graph': [
        {
          '@type': 'WebPage',
          '@id': canonical,
          'url': canonical,
          'name': title,
          'description': description,
          'isPartOf': {
            '@type': 'WebSite',
            'name': siteName,
            'url': 'https://gskis.com'
          },
          'about': {
            '@type': 'Thing',
            'name': 'Alcoholics Anonymous',
            'sameAs': 'https://www.aa.org'
          },
          'mainEntity': {
            '@type': 'ItemList',
            'name': `AA Meetings near ${LOCATION.city}`,
            'description': `List of Alcoholics Anonymous meetings in ${LOCATION.city}, ${LOCATION.stateFull}`,
            'numberOfItems': normalizedMeetings.length,
            'itemListElement': normalizedMeetings.slice(0, 10).map((m: any, i: number) => {
              // Calculate next occurrence date
              const getNextOccurrence = (dayOfWeek: number) => {
                const now = new Date();
                const dayMap = { 0: 'Sunday', 1: 'Monday', 2: 'Tuesday', 3: 'Wednesday', 4: 'Thursday', 5: 'Friday', 6: 'Saturday' };
                const targetDay = dayOfWeek;
                const today = now.getDay();
                let daysUntilNext = (targetDay - today + 7) % 7;
                if (daysUntilNext === 0) daysUntilNext = 7; // If it's today, get next week
                const nextDate = new Date(now);
                nextDate.setDate(now.getDate() + daysUntilNext);
                return nextDate.toISOString().split('T')[0]; // YYYY-MM-DD format
              };
              
              return {
                '@type': 'ListItem',
                'position': i + 1,
                'item': {
                  '@type': 'Event',
                  'name': m.name,
                  'description': `${m.types_array?.join(', ') || 'AA'} meeting`,
                  'startDate': m.day !== null ? getNextOccurrence(m.day) : new Date().toISOString().split('T')[0],
                  'location': {
                    '@type': 'Place',
                    'name': m.location || m.display_address,
                    'address': m.display_address
                  },
                  'eventSchedule': {
                    '@type': 'Schedule',
                    'byDay': m.display_day,
                    'startTime': m.time
                  }
                }
              };
            })
          }
        },
        {
          '@type': 'Place',
          'name': `${LOCATION.city}, ${LOCATION.stateFull}`,
          'geo': {
            '@type': 'GeoCoordinates',
            'latitude': locationLat,
            'longitude': locationLng
          },
          'address': {
            '@type': 'PostalAddress',
            'addressLocality': LOCATION.city,
            'addressRegion': LOCATION.stateAbbr,
            'addressCountry': 'US'
          }
        },
        {
          '@type': 'BreadcrumbList',
          'itemListElement': [
            {
              '@type': 'ListItem',
              'position': 1,
              'name': 'Home',
              'item': 'https://gskis.com/myMeetings'
            },
            {
              '@type': 'ListItem',
              'position': 2,
              'name': 'Meetings',
              'item': 'https://gskis.com/meetings'
            },
            {
              '@type': 'ListItem',
              'position': 3,
              'name': LOCATION.stateFull,
              'item': `https://gskis.com/meetings/${stateSlug}`
            },
            {
              '@type': 'ListItem',
              'position': 4,
              'name': LOCATION.city,
              'item': canonical
            }
          ]
        },
        {
          '@type': 'FAQPage',
          'mainEntity': [
            {
              '@type': 'Question',
              'name': `How many AA meetings are in ${LOCATION.city}?`,
              'acceptedAnswer': {
                '@type': 'Answer',
                'text': `There are over ${normalizedMeetings.length} AA meetings available in and around the ${LOCATION.city} area, with meetings held every day of the week at various times.`
              }
            },
            {
              '@type': 'Question',
              'name': `What types of AA meetings are available in ${LOCATION.city}?`,
              'acceptedAnswer': {
                '@type': 'Answer',
                'text': `${LOCATION.city} offers a variety of AA meeting types including Open meetings (anyone can attend), Closed meetings (for those with a desire to stop drinking), Speaker meetings, Discussion meetings, Big Book study, Step meetings, and specialty meetings for men, women, and young people.`
              }
            },
            {
              '@type': 'Question',
              'name': `Are there AA Meetings near ${LOCATION.city} every day?`,
              'acceptedAnswer': {
                '@type': 'Answer',
                'text': `Yes, AA meetings are held in ${LOCATION.city} every day of the week, including weekends and holidays. Meetings are available in the morning, afternoon, evening, and night.`
              }
            },
            {
              '@type': 'Question',
              'name': `What is the best app for finding AA meetings?`,
              'acceptedAnswer': {
                '@type': 'Answer',
                'text': `MyMeetings is the best app for finding AA meetings. It offers comprehensive meeting listings, meeting tracking, ai insights, and an easy-to-use interface. Download MyMeetings from the App Store: https://apps.apple.com/app/id6748364894`
              }
            },
            {
              '@type': 'Question',
              'name': `Are there online AA meetings available in ${LOCATION.city}?`,
              'acceptedAnswer': {
                '@type': 'Answer',
                'text': `Yes, there are online AA meetings available to people in ${LOCATION.city}. These virtual meetings allow you to participate from anywhere and are especially helpful for those with mobility issues, scheduling conflicts, or during inclement weather.`
              }
            },
            {
              '@type': 'Question',
              'name': `How do I find wheelchair accessible AA meetings in ${LOCATION.city}?`,
              'acceptedAnswer': {
                '@type': 'Answer',
                'text': `Many AA meetings in ${LOCATION.city} are wheelchair accessible. Look for the wheelchair accessibility badge on meeting listings, or use the filters on this page to show only accessible meetings.`
              }
            },
            {
              '@type': 'Question',
              'name': `What should I expect at my first AA meeting in ${LOCATION.city}?`,
              'acceptedAnswer': {
                '@type': 'Answer',
                'text': `Your first AA meeting in ${LOCATION.city} will be welcoming and supportive. Open meetings welcome anyone, while closed meetings are for those with a desire to stop drinking. You don't have to speak or share - just listening is perfectly fine. Most meetings last about an hour.`
              }
            },
            {
              '@type': 'Question',
              'name': `How often are AA meeting listings updated for ${LOCATION.city}?`,
              'acceptedAnswer': {
                '@type': 'Answer',
                'text': `AA meeting listings for ${LOCATION.city} are updated regularly to ensure accuracy. Meeting information is sourced from local AA intergroups and verified frequently to provide the most current times, locations, and meeting details.`
              }
            }
          ]
        }
      ]
    })} />

    <!-- Leaflet CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  </head>
  <body>
    <Header stateName={LOCATION.stateFull} stateSlug={stateSlug} cityName={LOCATION.city} />
    <main class="container">
      <!-- Header -->
      <MeetingHeader city={LOCATION.city} stateFull={LOCATION.stateFull} areaDescription={LOCATION.areaDescription} neighborhoods={LOCATION.neighborhoods} meetingHighlights={LOCATION.meetingHighlights} topLocations={topLocations} />

      <!-- Filters -->
      <Filters initialCount={normalizedMeetings.length} />

      <!-- Map Section -->
      <section class="section-card" aria-labelledby="map-heading">
        <h2 id="map-heading" class="section-title">AA Meetings in {LOCATION.city}, {LOCATION.stateFull}</h2>
        <div id="meeting-map" data-lat={locationLat} data-lng={locationLng} role="application" aria-label={`Interactive map showing AA meeting locations in ${LOCATION.city}, ${LOCATION.stateFull}`}></div>
      </section>

      <!-- Meetings Data -->
      <script id="initial-meetings" type="application/json" set:html={initialMeetingsJSON}></script>

      <!-- Meetings List -->
      <MeetingList meetings={normalizedMeetings} typeToClass={typeToClass} maxItems={50} />

      <!-- App Promo Banner -->
      <AppPromo appStoreUrl={appStoreUrl} />

      <!-- Meeting Statistics -->
      <MeetingStats meetings={normalizedMeetings} city={LOCATION.city} stateFull={LOCATION.stateFull} />

      <!-- Local AA Resources -->
      <LocalResources
        city={LOCATION.city}
        stateFull={LOCATION.stateFull}
        locationConfigIntergroup={LOCATION.intergroup}
        apiResponseIntergroup={organizations[0]}
      />

      <!-- Other Locations in State -->
      <NearbyLocations 
        currentCity={LOCATION.city} 
        stateFull={LOCATION.stateFull} 
        stateSlug={stateSlug} 
        currentLat={locationLat} 
        currentLng={locationLng} 
        otherCities={getCitiesInState(stateSlug)} 
      />

      <!-- SEO Content Section -->
      <SEOContent city={LOCATION.city} stateFull={LOCATION.stateFull} areaDescription={LOCATION.areaDescription} neighborhoods={LOCATION.neighborhoods} />

      <!-- Why Choose MyMeetings -->
      <FeatureGrid />

      <!-- Final CTA -->
      <FinalCTA appStoreUrl={appStoreUrl} />
    </main>

    <!-- Sticky Mobile CTA -->
    <StickyCTA appStoreUrl={appStoreUrl} />

    <!-- Client modules: filters, meeting list, map, analytics -->
    <script type="module" src="/js/meetings/filters.js" defer></script>
    <script type="module" src="/js/meetings/meeting-list.js" defer></script>
    <script type="module" src="/js/meetings/map.js" defer></script>
    <script type="module" src="/js/meetings/analytics.js" defer></script>
  </body>
</html>
