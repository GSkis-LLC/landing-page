---
const { meetings = [], city, stateFull } = Astro.props;

// Calculate real statistics from meeting data
const totalMeetings = meetings.length;
const meetingsByDay = [0, 0, 0, 0, 0, 0, 0];
const meetingTypes = new Map<string, number>();
const locations = new Set<string>();
const meetingsByPeriod = new Map<string, number>();
let onlineMeetings = 0;

meetings.forEach((m: any) => {
  // Count by day
  if (m.day != null) {
    meetingsByDay[m.day] = (meetingsByDay[m.day] || 0) + 1;
  }
  
  // Count by type
  if (m.types_array) {
    m.types_array.forEach((t: string) => {
      meetingTypes.set(t, (meetingTypes.get(t) || 0) + 1);
    });
  }
  
  // Count unique locations
  if (m.location_id) {
    locations.add(String(m.location_id));
  }
  
  // Count online
  if (m.conference_url) {
    onlineMeetings++;
  }
  
  // Count by time period
  if (m.time_periods && m.time_periods.length > 0) {
    m.time_periods.forEach((period: string) => {
      meetingsByPeriod.set(period, (meetingsByPeriod.get(period) || 0) + 1);
    });
  }
});

const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
const busiestDayIndex = meetingsByDay.indexOf(Math.max(...meetingsByDay));
const busiestDay = dayNames[busiestDayIndex];

// Get top 5 meeting types
const topTypes = [...meetingTypes.entries()]
  .sort((a, b) => b[1] - a[1])
  .slice(0, 5);

const uniqueLocations = locations.size;
---

<section class="section-card meeting-stats" aria-labelledby="stats-heading">
  <h2 id="stats-heading" class="section-title">AA Meeting Statistics for {city}</h2>
  
  <div class="stats-grid">
    <div class="stat-item">
      <span class="stat-number">{totalMeetings}</span>
      <span class="stat-label">Total Meetings</span>
    </div>
    <div class="stat-item">
      <span class="stat-number">{uniqueLocations}</span>
      <span class="stat-label">Meeting Locations</span>
    </div>
    <div class="stat-item">
      <span class="stat-number">{onlineMeetings}</span>
      <span class="stat-label">Online Meetings</span>
    </div>
    <div class="stat-item">
      <span class="stat-number">7</span>
      <span class="stat-label">Days per Week</span>
    </div>
  </div>

  <div class="stats-details">
    <p><strong>Busiest day:</strong> {busiestDay} with {meetingsByDay[busiestDayIndex]} meetings</p>
    
    {topTypes.length > 0 && (
      <p><strong>Most common meeting types:</strong> {topTypes.map(([type, count]) => `${type} (${count})`).join(', ')}</p>
    )}
    
    <div class="time-periods">
      <h3>Meetings by Time of Day</h3>
      <div class="time-grid">
        {['morning', 'evening', 'night'].map(period => {
          const count = meetingsByPeriod.get(period) || 0;
          return (
            <div class="time-stat">
              <span class="time-number">{count}</span>
              <span class="time-label">{period.charAt(0).toUpperCase() + period.slice(1)}</span>
            </div>
          );
        })}
      </div>
    </div>
    
    <p class="stats-note">
      Meeting data is regularly updated to ensure accuracy.
    </p>
  </div>
</section>

<style>
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .stat-item {
    text-align: center;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 8px;
  }
  
  .stat-number {
    display: block;
    font-size: 2rem;
    font-weight: 700;
    color: #2A9D8F;
  }
  
  .stat-label {
    font-size: 0.875rem;
    color: #64748b;
  }
  
  .stats-details {
    font-size: 0.95rem;
    color: #475569;
  }
  
  .stats-details p {
    margin: 0.5rem 0;
  }
  
  .stats-note {
    margin-top: 1rem;
    font-size: 0.85rem;
    color: #94a3b8;
  }
  
  .stats-note a {
    color: #2A9D8F;
  }
  
  .time-periods {
    margin: 1.5rem 0;
  }
  
  .time-periods h3 {
    margin: 0 0 1rem 0;
    font-size: 1.1rem;
    color: #334155;
  }
  
  .time-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 0.75rem;
  }
  
  .time-stat {
    text-align: center;
    padding: 0.75rem;
    background: #f1f5f9;
    border-radius: 6px;
    border-left: 3px solid #2A9D8F;
  }
  
  .time-number {
    display: block;
    font-size: 1.5rem;
    font-weight: 600;
    color: #2A9D8F;
  }
  
  .time-label {
    font-size: 0.8rem;
    color: #64748b;
    text-transform: capitalize;
  }
</style>
